

{% extends "base.html" %}
{% block head %}
    <title>PANSON: ADMIN</title>
{% endblock %}

{% block imports %}
    <link href='/style/admin.css' as='style' rel='preload'>
    <link href='/style/admin-img.css' as='style' rel='preload'>
    <link href='/style/admin-trello.css' as='style' rel='preload'>
    <link href='/scripts/admin.js' as='script' rel='preload'>
    <link href='/scripts/admin-trello.js' as='script' rel='preload'>

    <script defer type="text/javascript" src="/scripts/admin.js"></script>
    <script defer type="text/javascript" src="/scripts/admin-trello.js"></script>
    <link href='/style/admin.css' rel='stylesheet'>
    <link href='/style/admin-img.css' rel='stylesheet'>
    <link href='/style/admin-trello.css' rel='stylesheet'>

{% endblock %}



{% block body %}
<div id="nav-color" navColor="opaque"></div>
	<body>
		<div id="admin-common">
			<div id="admin-header"></div>
			<div id=admin-menu>
                <button onclick="window.location.href='/admin/productes'" class="loc" loc="admin-menu-productes">{{ loc.admin_menu_productes }}</button>
				<button onclick="window.location.href='/admin/bespoke'" class="loc" loc="admin-menu-bespoke">{{ loc.admin_menu_bespoke }}</button>
				<button onclick="window.location.href='/admin/collecions'" class="loc" loc="admin-menu-collecions">{{ loc.admin_menu_collecions }}</button>
				<button onclick="window.location.href='/admin/localisation'" class="loc" loc="admin-menu-localisation">{{ loc.admin_menu_localisation }}</button>
                <button onclick="window.location.href='/admin/imatges'"  class="loc" loc="admin-menu-imatges">{{ loc.admin_menu_imatges }}</button>
                <button onclick="window.location.href='/admin/trello'" class="loc" loc="admin-menu-trello">{{ loc.admin_menu_trello }}</button>
                <button onclick="window.location.href='/admin/misc'" class="loc" loc="admin-menu-avancat">{{ loc.admin_menu_avancat }}</button>

                {% if user.super %}
                {% endif %}
			</div>
		</div>
		<div id=admin-page>
			{% block content %}{% endblock %}
		</div>
        	{{ image_selector() }}

	</body>

{% endblock %}







{% macro admin_container(product) %}
<div class="product-container" id={{product._id}}>
	<div class="product-header {{product._id}}" onclick="showPopup(this.nextElementSibling)">
		
		{% if product.bucket != "imatges" %}
            <button type="button" class="product-button product-hide {{ "hide" if product.amagat }}" product="{{product._id}}" field="amagat" value="True" dataType="bool" onclick="event.stopPropagation(productUpdate(this)); this.style.display='none'; this.nextElementSibling.style.display = 'block'; this.parentElement.getElementsByClassName('product-title')[0].innerHTML = this.parentElement.parentElement.getElementsByClassName('name')[0].firstElementChild.value + ' (Amagat)'">Amagar</button>
            <button type="button" class="product-button product-show {{ "hide" if not product.amagat }}" product="{{product._id}}" field="amagat" value="False" dataType="bool" onclick="event.stopPropagation(productUpdate(this)); this.style.display='none'; this.previousElementSibling.style.display = 'block'; this.parentElement.getElementsByClassName('product-title')[0].innerHTML = this.parentElement.parentElement.getElementsByClassName('name')[0].firstElementChild.value">Mostrar</button>
            <button type="button" class="product-button product-delete {{ "hide" if product.esborrat }}" product="{{product._id}}" field="esborrat" value="True" dataType="bool" onclick="event.stopPropagation(productUpdate(this)); this.parentElement.parentElement.remove()">ESBORRAR</button>
	        	    <button type="button" class="product-button go-to-product" onclick="window.open('/{{loc.lan}}/{{product.bucket}}/{{product._id}}', '_blank')">Veure a la botiga</button>

        {% endif%}

	    <div class="product-title {{product._id}}" >{{product.nom}} {{ "(Amagat)" if product.amagat }}</div>
        <div class="product-id">{{product._id}}</div>
	    <div class="product-snapshot normal-image" background='{{ imgs.get_url(product.bucket, product.imatges[0]) }}'></div>
        </div>



	<div class="product-data popup-info {{product._id}}">
		<div>ID: {{product._id}}</div>
        <div class="horizontal wrapper">
            <div class="vertical wrapper">
                <div class="horizontal wrapper">
                    <div class="product-element name">Nom: <input product="{{product._id}}" field="nom" class="product-input" value="{{product.nom}}" oninput="this.nextElementSibling.style.backgroundColor = 'yellow'; document.documentElement.querySelector('.product-title.{{product._id}}').innerHTML=this.value" colorcode="next"><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>
                    {% if product.bucket == "productes" %}
                        <div class="product-element info">Info: <textarea product="{{product._id}}" field="info" class="product-input" onmouseenter="resizeArea(this)" oninput="this.nextElementSibling.style.backgroundColor = 'yellow'; resizeArea(this)" colorcode="next">{{product.info}}</textarea><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>
                    {% elif product.bucket == "collecions" %}
                        <div class="product-element name">Nom Menu: <input product="{{product._id}}" field="nom_menu" class="product-input" value="{{product.nom_menu}}" oninput="this.nextElementSibling.style.backgroundColor = 'yellow';" colorcode="next"><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>
                    {% endif %}
                </div>

            {% if product.bucket == "productes" %}
                <div class="product-element subtitle">Subtitol: <input product="{{product._id}}" field="subtitol" class="product-input" value="{{product.subtitol}}" oninput="this.nextElementSibling.style.backgroundColor = 'yellow';"><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>
                <div class="horizontal wrapper">
                    <div class="product-element type">Tipus:
                        <select product="{{product._id}}" field="tipus" class="product-input" oninput="productUpdate(this)">
                                <option value=""></option>
                                {% for tipus in loc.misc["types"] %}
                                    <option value="{{ tipus }}" {{ "selected=selected" if tipus == product.tipus }}>{{ tipus }}</option>
                                {% endfor %}
                        </select><div></div>
                    </div>
		    <div class="product-element start-date">Estrena:
			    <input type="datetime-local" product="{{product._id}}" field="start_date" class="product-input" value="{{product.start_date}}" oninput="productUpdate(this)">
		    </div>
                </div>
                <div class="horizontal wrapper">
                    <div class="product-element collection">Collecio:
                        <select product="{{product._id}}" field="collecio" class="product-input" oninput="productUpdate(this)">
                            <option value=""></option>
                            {% for collecio in collecions %}
                                <option value="{{ collecio._id }}" {{ "selected=selected" if collecio._id == product.collecio }}>{{ collecio.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="horizontal spacer"></div>
                    <div class="product-element unica">Unica:
                        <select product="{{product._id}}" field="unica" dataType="bool" class="product-input" oninput="productUpdate(this);">
                            {% for b in [True, False] %}
                                <option value="{{ b }}" {{ "selected=selected" if product.unica == b }}>{{ loc.misc["bools"]["{}".format(b)] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="horizontal wrapper">
                    <div class="product-element new-in">Novetat:
                        <select product="{{product._id}}" field="novetat" dataType="bool" class="product-input" oninput="productUpdate(this);">
                            {% for b in [True, False] %}
                                <option value="{{ b }}" {{ "selected=selected" if product.novetat == b }}>{{ loc.misc["bools"]["{}".format(b)] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="horizontal spacer"></div>
                    <div class="product-element popular">Popular:
                        <select product="{{product._id}}" field="popular" dataType="bool" class="product-input" oninput="productUpdate(this);">
                            {% for b in [True, False] %}
                                <option value="{{ b }}" {{ "selected=selected" if product.popular == b }}>{{ loc.misc["bools"]["{}".format(b)] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
        {% endif %}
        </div>
        <div class="horizontal spacer"></div>

        {% if product.bucket != "imatges" %}
                <div class="product-element description">Descripcio: <textarea product="{{product._id}}" field="descripcio" class="product-input" onmouseenter="resizeArea(this)" oninput="this.nextElementSibling.style.backgroundColor = 'yellow'; resizeArea(this)" colorcode="next">{{product.descripcio}}</textarea><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>
        {% endif %}

    </div>

    <div class="vertical wrapper">

        {% if product.bucket == "productes" %}
            <div class="horizontal wrapper">
                <div class="product-element material">Material:
                    <ul>
                        {% if product.opcions.get("materials") == None %}
                            {% set materials = {"": {"":""}} %}
                        {% else %}
                            {% set materials = product.opcions.get("materials") %}
                        {% endif %}
                        {% for n, (subkey, info) in utils.enumerate(utils.list(materials.items())) %}
                            <li>
                                <select class="dict-key {{ "hidden" if subkey !="" }}" subdict="materials" product="{{product._id}}" field="opcions" dataType="dict:text">
					<option value=""></option>
					{% for m in loc.get_values_by_page("mat").keys() %}
					<option value="{{m}}" {{"selected" if subkey == m}}>{{m}}</option>
					{% endfor %}
				</select>
					<span>{{ subkey }}</span>
                                Preu: <input type="number" dataType="int" class="product-input dict-input" key="preu" value="{{ info["preu"] }}">
                                <button class="product-update" onclick="productUpdateDict(this.parentElement, 'add')">&#10004;</button>
                                <button class="product-update" onclick="productUpdateDict(this.parentElement, 'remove')">✖</button>
                            </li>
                        {% endfor %}
                    </ul>
                    <button type="button" onclick="addListElement(this.previousElementSibling, 'text')">+</button>
                </div>
                <div class="horizontal spacer"></div>
                <div class="product-element variacio">Variacions:
                    <ul>
                        {% if product.opcions.get("variacions") == None %}
                            {% set variacions = {"": {"":""}} %}
                        {% else %}
                            {% set variacions = product.opcions.get("variacions") %}
                        {% endif %}
                        {% for n, (subkey, info) in utils.enumerate(utils.list(variacions.items())) %}
                            <li>
				    <select class="dict-key {{"hidden" if subkey != "" }}" subdict="variacions" product="{{product._id}}" field="opcions" dataType="dict:text">
					    <option value=""></option>
					    {% for v in loc.get_values_by_page("var") %}
					    <option value="{{v}}" {{ "selected" if subkey == v }}>{{v}}</option>
					    {% endfor %}
				    </select>
				    <span>{{ subkey }}</span><br>
				Preu: <input type="number" dataType="int" class="product-input dict-input" key="preu" value="{{ info["preu"] }}">
				Link: <select dataType="text" key="link" class="product-input dict-input">
					<option value=""></option>
					{% for p in productes.filter({"collecio":product.collecio}) %}
					<option value="{{ "/"+p.bucket+"/"+p._id }}" {{"selected" if "/"+p.bucket+"/"+p._id== info.get("link","") }}>{{p._id}}</option>
					{% endfor %}
				</select>
                                <button class="product-update" onclick="productUpdateDict(this.parentElement, 'add')">&#10004;</button>
                                <button class="product-update" onclick="productUpdateDict(this.parentElement, 'remove')">✖</button>
                            </li>
                        {% endfor %}
                    </ul>
                    <button type="button" onclick="addListElement(this.previousElementSibling, 'text')">+</button>
                </div>
            </div>

            <div class="horizontal wrapper">
                <div class="product-element totes-talles">Talles Predefinides:
                    <select product="{{product._id}}" field="totes_talles" dataType="bool" class="product-input" oninput="productUpdate(this);">
                        {% for b in [True, False] %}
                            <option value="{{ b }}" {{ "selected=selected" if product.totes_talles == b }}>{{ loc.misc["bools"]["{}".format(b)] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="horizontal spacer"></div>
                <div class="product-element talles">Talles:
                    {% if product.opcions.get("talles") == None %}
                        {% set talles = {"": {"":""}} %}
                    {% else %}
                        {% set talles = product.opcions.get("talles") %}
                    {% endif %}
                    <ul>
                        {% for n, (subkey, info) in utils.enumerate(utils.list(talles.items())) %}
                            <li>
                                <input type="{{ "hidden" if product.opcions["talles"] }}" subdict="talles" class="dict-key" product="{{product._id}}" field="opcions" dataType="dict:text" value="{{ subkey }}"><span>{{ subkey }}</span>
                                Quantitat: <input type="number" dataType="int" class="product-input dict-input" key="qty" value="{{ info["qty"] }}">
				Link: <select dataType="text" key="link" class="product-input dict-input">
					<option value=""></option>
                                        {% for p in productes.filter({"collecio":product.collecio}) %}
                                        <option value="{{ "/"+p.bucket+"/"+p._id }}" {{"selected" if "/"+p.bucket+"/"+p._id== info.get("link","") }}>{{p._id}}</option>                                                                 {% endfor %}                                                                            </select>
                                <button class="product-update" onclick="productUpdateDict(this.parentElement, 'add')">&#10004;</button>
                                <button class="product-update" onclick="productUpdateDict(this.parentElement, 'remove')">✖</button>
                            </li>
                        {% endfor %}
                    </ul>
                    <button type="button" onclick="addListElement(this.previousElementSibling, 'text')">+</button>
                </div>
            </div>

            <div class="horizontal wrapper">
                <div class="product-element colors">Colors:
                    <input class="n-colors-input" type="number" value={{product.opcions.get("n_colors", 0) }} product="{{product._id}}"  field="opcions" key="n_colors" onchange="updateExtraColors(this, this.parentElement.nextElementSibling)">

                    {% if product.opcions.get("colors") == None %}
                        {% set colors = {"":{"":""}} %}
                    {% else %}
                        {% set colors = product.opcions.get("colors") %}
                    {% endif %}

                    <div class="all-colors" product={{product._id}} field="opcions" key="colors">
                        {% for c_name, c in loc.misc["colours"].items() %}
                            <div class="color-circle {{"selected" if c_name in colors.keys()}}" style="background-color: {{c}}" onclick="this.classList.toggle('selected');" value="{{c_name}}">{{c_name}}</div>
                        {% endfor %}
                    </div>
                    <button class="product-update" onclick="productUpdateColors(this.parentElement)">&#10004;</button>
                </div>
                <div class="horizontal spacer"></div>
                <div class="product-element extra-colors {{"hidden" if product.opcions.get("n_colors", 0) == 0}}" colorcode="this" product="{{product._id}}" field="opcions" key="extra_colors">Detalls colors:
                    <ol>
                        <li class="extra-color template">
                            <select class="extra-color-input template">
                                <option value="">Normal</option>
                                {% for pedra in ["pro-pedra-gran", "pro-pedra-petita"] %}
                                    <option value="{{ pedra }}">{{ loc[pedra] }}</option>
                                {% endfor %}
                            </select>
                        </li>
                        {% for c in product.opcions.get("extra_colors", [""]*product.opcions.get("n_colors", 0)) %}
                        <li class="extra-color">
                            <select class="extra-color-input">
                                <option value="">Normal</option>
                                {% for pedra in ["pro-pedra-gran", "pro-pedra-petita"] %}
                                <option {{ "selected" if c == pedra }} value="{{ pedra }}">{{ loc[pedra] }}</option>
                                {% endfor %}
                            </select>
                        </li>
                        {% endfor %}
                    </ol>
                        <button class="product-update" onclick="productUpdateExtraColors(this.parentElement)">&#10004;</button>
                </div>
            </div>





            {% elif product.bucket == "bespoke" %}

                <div class="product-element for">Per a: <input product="{{product._id}}" field="per_a"  class="product-input" value="{{product.per_a}}" oninput="this.nextElementSibling.style.backgroundColor = 'yellow';"><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>

            {% elif product.bucket == "collecions" %}

                <div class="product-element background">Navegacio blanca:
                    <select product="{{product._id}}" field="fons_blanc" dataType="bool" class="product-input" oninput="productUpdate(this);">
                                {% for b in [True, False] %}
                                    <option value="{{ b }}" {{ "selected=selected" if product.unica == b }}>{{ loc.misc["bools"]["{}".format(b)] }}</option>
                                {% endfor %}
                    </select><div></div>
                </div>

            {% endif %}


        </div>
            <div class="product-images">
                {% for n, image in utils.enumerate(product.imatges) %}
		
		<div class="product-image slow-image clickable {{ 'as-template' if n==utils.len(product.imatges)-1  }}" product="{{product._id}}" field="imatges" value="{{ image }}" background='{{ imgs.get_url(product.bucket, image) }}' filename="{{ image }}" bucket="{{ product.bucket }}" onclick='showImgDetails(this)'>
                        <button type=button class=product-image-left  onclick="event.stopPropagation(); productImageMove(this.parentElement, false)">&larr;</button>
                        <button type=button class=product-image-right onclick="event.stopPropagation(); productImageMove(this.parentElement, true)">&rarr;</button>
                        <button type=button class=product-image-delete onclick="event.stopPropagation(); productImageDelete(this.parentElement)">&#10008;</button>
                    </div>
                {% endfor %}
		<button class="product-image-upload" onclick="this.lastElementChild.click()">&#9729;<br>&#8613;<br>&#10133;<br>Pujar<input type="file" multiple class="product-image-input" oninput="uploadFiles(this, this.parentElement.previousElementSibling)" field="imatges" product="{{product._id}}" ></button>
		<button class="product-image-select" onclick="showImageSelector(this,'{{ product._id }}')">&#9729;<br>&#8615;<br>&#10133;<br>Seleccionar</button>
            </div>
        </div>
    </div>
{% endmacro %}


{% macro new_container(bucket) %}

    <div class="product-container">
        <form action="/admin/create/{{ bucket }}" method="post">
            <div class="product-header">
                <input name=name class="product-title" placeholder="NOM">
                <input name=id class="product-id" placeholder="ID">
                <button type=submit>CREAR</button>
            </div>
        </form>
    </div>
{% endmacro %}




{% macro image_selector() %}

<dialog class="image-selector container-closer hidden" onclick="this.classList.toggle('hidden');">
    <div class="image-selector-content img-details" onclick="event.stopPropagation();">
        <div class="image-selector-title">Bucket</div>
        <div class="image-selector-gallery">
            <div class="image-selector-image template" onclick="selectThis(this)"></div>
        </div>
        <div class="image-selector-confirm" dataType="list:text" onclick="confirmSelection(this)">Confirmar</div>
    </div>
</dialog>
{% endmacro %}








