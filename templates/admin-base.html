

{% extends "base.html" %}
{% block head %}
    <title>PANSON: ADMIN</title>
{% endblock %}

{% block imports %}
    <link href='/style/admin.css' as='style' rel='preload'>
    <link href='/scripts/admin.js' as='script' rel='preload'>

    <script defer type="text/javascript" src="/scripts/admin.js"></script>
    <link href='/style/admin.css' rel='stylesheet'>
    <link href='/style/admin-img.css' rel='stylesheet'>

{% endblock %}



{% block body %}

	<body>
		<div id="admin-common">
			<div id="admin-header">ADMIN</div>
			<div id=admin-menu>
                <button onclick="window.location.href='/admin/productes/'">Productes</button>
				<button onclick="window.location.href='/admin/bespoke/'">Bespoke</button>
				<button onclick="window.location.href='/admin/collecions/'">Collecions</button>
				<button onclick="window.location.href='/admin/localisation/'">Localitzacio</button>
				{% if user.username == "iain" %}

                    <button onclick="window.location.href='/admin/imatges/'">Imatges</button>
                    <button onclick="window.location.href='/admin/misc/'">Misc</button>

				{% endif %}
			</div>
		</div>
		<div id=admin-page>
			{% block content %}{% endblock %}
		</div>
        	{{ image_selector() }}

	</body>

{% endblock %}







{% macro admin_container(product) %}
<div class="product-container" id={{product._id}}>
        <div class="product-header" onclick="showData(this)">
            <button type="button" class="product-button product-hide {{ "hide" if product.amagat }}" product="{{product._id}}" field="amagat" value="True" dataType="bool" onclick="event.stopPropagation(productUpdate(this)); this.style.display='none'; this.nextElementSibling.style.display = 'block'; this.parentElement.getElementsByClassName('product-title')[0].innerHTML = this.parentElement.parentElement.getElementsByClassName('name')[0].firstElementChild.value + ' (Amagat)'">Amagar</button>
            <button type="button" class="product-button product-show {{ "hide" if not product.amagat }}" product="{{product._id}}" field="amagat" value="False" dataType="bool" onclick="event.stopPropagation(productUpdate(this)); this.style.display='none'; this.previousElementSibling.style.display = 'block'; this.parentElement.getElementsByClassName('product-title')[0].innerHTML = this.parentElement.parentElement.getElementsByClassName('name')[0].firstElementChild.value">Mostrar</button>
            <button type="button" class="product-button product-delete {{ "hide" if product.esborrat }}" product="{{product._id}}" field="esborrat" value="True" dataType="bool" onclick="event.stopPropagation(productUpdate(this)); this.parentElement.parentElement.remove()">ESBORRAR</button>

            <div class="product-title" >{{product.nom}} {{ "(Amagat)" if product.amagat }}</div>
            <div class="product-id">{{product._id}}</div>
            <div class="product-snapshot normal-image" background='{{ imgs.get_url(product.bucket, product.imatges[0]) }}'></div>
        </div>
        <div class="product-data hide">
            <div class="product-element name">Nom: <input product="{{product._id}}" field="nom" class="product-input" value="{{product.nom}}" oninput="this.nextElementSibling.style.backgroundColor = 'yellow'; this.parentElement.parentElement.parentElement.getElementsByClassName('product-title')[0].innerHTML=this.value"><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>
            <div class="product-element description">Descripcio: <textarea product="{{product._id}}" field="descripcio" class="product-input" oninput="this.nextElementSibling.style.backgroundColor = 'yellow';">{{product.descripcio}}</textarea><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>

            {% if product.bucket == "productes" %}
                <div class="product-element subtitle">Subtitol: <input product="{{product._id}}" field="subtitol" class="product-input" value="{{product.subtitol}}" oninput="this.nextElementSibling.style.backgroundColor = 'yellow';"><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>
                <div class="product-element type">Tipus:
                    <select product="{{product._id}}" field="tipus" class="product-input" oninput="productUpdate(this)">
                            <option value=""></option>
                            {% for tipus in loc.misc["types"] %}
                                <option value="{{ tipus }}" {{ "selected=selected" if tipus == product.tipus }}>{{ tipus }}</option>
                            {% endfor %}
                    </select><div></div>
                </div>
                <div class="product-element collection">Collecio:
                    <select product="{{product._id}}" field="collecio" class="product-input" oninput="productUpdate(this)">
                <option value=""></option>
                            {% for collecio in productes.col_names %}
                                <option value="{{ collecio.lower() }}" {{ "selected=selected" if collecio.lower() == product.collecio }}>{{ collecio }}</option>
                            {% endfor %}
                    </select><div></div>
                </div>
                <div class="product-element collection">Unica:
                <select product="{{product._id}}" field="unica" dataType="bool" class="product-input" oninput="productUpdate(this);">
                            {% for b in [True, False] %}
                                <option value="{{ b }}" {{ "selected=selected" if product.unica == b }}>{{ loc.misc["bools"]["{}".format(b)] }}</option>
                            {% endfor %}
                </select><div></div>
                </div>


                <div class="product-element material">Material:<ul>
			{% if product.opcions.get("materials") == None %}
				{% set materials = {"": {"":""}} %}
			{% else %}
				{% set materials = product.opcions.get("materials") %}
			{% endif %}
			
                            {% for n, (subkey, info) in utils.enumerate(utils.list(materials.items())) %}
                                <li>
                                    <input type="{{ "hidden" if product.opcions["materials"] }}" subdict="materials" class="dict-key" product="{{product._id}}" field="opcions" dataType="dict:text" value="{{ subkey }}"><span>{{ subkey }}</span>
                                    Preu: <input type="number" dataType="int" class="product-input dict-input" key="preu" value="{{ info["preu"] }}">
                                    <button class="product-update" onclick="productUpdateDict(this.parentElement, 'add')">&#10004;</button>
                                    <button class="product-update" onclick="productUpdateDict(this.parentElement, 'remove')">✖</button>
                                </li>
                            {% endfor %}
                        </ul><button type="button" onclick="addListElement(this.previousElementSibling, 'text')">+</button>
                </div>

                <div class="product-element variacio">Variacio:<ul>
			{% if product.opcions.get("variacions") == None %}
				{% set variacions = {"": {"":""}} %}
			{% else %}
				{% set variacions = product.opcions.get("variacions") %}
			{% endif %}
                            {% for n, (subkey, info) in utils.enumerate(utils.list(variacions.items())) %}
                                <li>
                                    <input type="{{ "hidden" if product.opcions["variacions"] }}" subdict="variacions" class="dict-key" product="{{product._id}}" field="opcions" dataType="dict:text" value="{{ subkey }}"><span>{{ subkey }}</span>
                                    Preu: <input type="number" dataType="int" class="product-input dict-input" key="preu" value="{{ info["preu"] }}">
                                    <button class="product-update" onclick="productUpdateDict(this.parentElement, 'add')">&#10004;</button>
                                    <button class="product-update" onclick="productUpdateDict(this.parentElement, 'remove')">✖</button>
                                </li>
                            {% endfor %}
                        </ul><button type="button" onclick="addListElement(this.previousElementSibling, 'text')">+</button>
                </div>

                <div class="product-element talles">Talles:<ul>
			{% if product.opcions.get("talles") == None %}
				{% set talles = {"": {"":""}} %}
			{% else %}
				{% set talles = product.opcions.get("talles") %}
			{% endif %}
                            {% for n, (subkey, info) in utils.enumerate(utils.list(talles.items())) %}
                                <li>
                                    <input type="{{ "hidden" if product.opcions["talles"] }}" subdict="variacions" class="dict-key" product="{{product._id}}" field="opcions" dataType="dict:text" value="{{ subkey }}"><span>{{ subkey }}</span>
                                    Quantitat: <input type="number" dataType="int" class="product-input dict-input" key="qty" value="{{ info["qty"] }}">
                                    <button class="product-update" onclick="productUpdateDict(this.parentElement, 'add')">&#10004;</button>
                                    <button class="product-update" onclick="productUpdateDict(this.parentElement, 'remove')">✖</button>
                                </li>
                            {% endfor %}
                        </ul><button type="button" onclick="addListElement(this.previousElementSibling, 'text')">+</button>
                </div>



                <!-- TODO: colors input -->


            {% elif product.bucket == "bespoke" %}

                <div class="product-element for">Per a: <input product="{{product._id}}" field="per_a"  class="product-input" value="{{product.per_a}}" oninput="this.nextElementSibling.style.backgroundColor = 'yellow';"><button class="product-update" onclick="productUpdate(this.previousElementSibling)">&#10004;</button></div>

            {% elif product.bucket == "collecions" %}

                <div class="product-element background">Navegacio blanca:
                    <select product="{{product._id}}" field="fons_blanc" dataType="bool" class="product-input" oninput="productUpdate(this);">
                                {% for b in [True, False] %}
                                    <option value="{{ b }}" {{ "selected=selected" if product.unica == b }}>{{ loc.misc["bools"]["{}".format(b)] }}</option>
                                {% endfor %}
                    </select><div></div>
                </div>

            {% endif %}



            <div class="product-images">
                {% for n, image in utils.enumerate(product.imatges) %}
		
		<div class="product-image slow-image {{ 'as-template' if n==utils.len(product.imatges)-1  }}" product="{{product._id}}" field="imatges" value="{{ image }}" background='{{ imgs.get_url(product.bucket, image) }}'>
                        <button type=button class=product-image-left  onclick="productImageMove(this.parentElement, false)">&larr;</button>
                        <button type=button class=product-image-right onclick="productImageMove(this.parentElement, true)">&rarr;</button>
                        <button type=button class=product-image-delete onclick="productImageDelete(this.parentElement)">&#10008;</button>
                    </div>
                {% endfor %}
                    <button class="product-image-add" onclick="this.firstElementChild.click()">&#10133;<input type="file" multiple class="product-image-input" oninput="uploadFiles(this, 'productes', this.parentElement.previousElementSibling)" field="imatges" product="{{product._id}}" ></button>
		    <button class="product-image-add" onclick="showImageSelector(this,'{{ product._id }}')">&#10133;</button>
            </div>
        </div>
    </div>
{% endmacro %}


{% macro new_container(bucket) %}

    <div class="product-container">
        <form action="/admin/create/{{ bucket }}" method="post">
            <div class="product-header" onclick="showData(this)">
                <input name=name class="product-title" placeholder="NOM">
                <input name=id class="product-id" placeholder="ID">
                <button type=submit>CREAR</button>
            </div>
        </form>
    </div>
{% endmacro %}




{% macro image_selector() %}
DiALoG
<dialog class="image-selector container-closer hidden" onclick="this.classList.toggle('hidden');">
    <div class="image-selector-content img-details" onclick="event.stopPropagation();">
        <div class="image-selector-title">Bucket</div>
        <div class="image-selector-gallery">
            <div class="image-selector-image template" onclick="selectThis(this)"></div>
        </div>
        <div class="image-selector-confirm" dataType="list:text" onclick="confirmSelection(this)">Confirmar</div>
    </div>
</dialog>
{% endmacro %}








